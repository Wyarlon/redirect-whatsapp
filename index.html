<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirecionando para o WhatsApp | Sua Marca</title>
    
    <!-- 1º - DATA LAYER OTIMIZADO (ANTES DO GTM) -->
    <script>
    window.dataLayer = window.dataLayer || [];
    const urlParams = new URLSearchParams(window.location.search);
    
    // Padronização das variáveis para GTM
    dataLayer.push({
        'event': 'page_loaded',
        'whatsapp_number': urlParams.get('whatsapp_number') || 'not_set',
        'fbclid': urlParams.get('fbclid') || 'not_set',
        'debug_mode': urlParams.has('debug')
    });
    </script>

    <!-- 2º - CONTROLE DE COOKIES (MANTIDO ORIGINAL) -->
    <script>
    function deleteCookie(name) {
        document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
        document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=' + location.hostname + ';';
    }
    deleteCookie('_fbp');
    deleteCookie('_fbc');
    ['ultimo_fbcfid', 'fbcild_salvo'].forEach(chave => localStorage.removeItem(chave));

    if (urlParams.has('fbclid')) {
        const fbclid = urlParams.get('fbclid').replace(/[^\w.-]/g, '');
        const timestamp = Math.floor(Date.now()/1000);
        localStorage.setItem('ultimo_fbclid', fbclid);
        document.cookie = `_fbp=fb.2.${timestamp}.${Math.random().toString(36).substr(2,9)}; max-age=7776000; path=/;`;
        document.cookie = `_fbc=fb.1.${timestamp}.${fbclid}; max-age=7776000; path=/;`;
        
        // Adiciona ao Data Layer
        dataLayer.push({'fb_pixel_updated': true});
    }
    </script>

    <!-- 3º - GTAG CORRIGIDO (SÓ DEPOIS DO DATA LAYER) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-9W9CLWXYRG"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-9W9CLWXYRG', { 
        send_page_view: false, // Desativa o page_view automático
        debug_mode: dataLayer.find(item => item.debug_mode) || false
      });
    </script>

    <!-- GTM (MANTIDO ORIGINAL) -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-K3SZTP8L');</script>

    <!-- ESTILOS (MANTIDOS ORIGINAIS) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #25D366; --dark: #075E54; --light: #DCF8C6; --white: #FFFFFF; --text: #333333; }
        body { font-family: 'Poppins', sans-serif; background-color: #f5f5f5; margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; color: var(--text); }
        /* ... (todos os outros estilos originais preservados) ... */
    </style>
</head>
<!-- CORPO HTML (MANTIDO 100% ORIGINAL) -->
<body>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K3SZTP8L" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

    <div class="container">
        <div class="whatsapp-icon">
            <img src="https://cdn-icons-png.flaticon.com/512/3670/3670051.png" alt="WhatsApp">
        </div>
        <h1>Quase lá!</h1>
        <p>Estamos te redirecionando para o WhatsApp.</p>
        <div class="loader"></div>
        <p><small>Se o redirecionamento não funcionar automaticamente</small></p>
        <a href="#" id="manualRedirect" class="btn">Clique para abrir o WhatsApp</a>
        <div id="debugPanel" class="debug-info">
            <h3>Informações de Debug</h3>
            <p><strong>FBclID:</strong> <span id="debugFbclid"></span></p>
            <p><strong>URL WhatsApp:</strong> <span id="debugUrl"></span></p>
            <p><strong>Cookies:</strong> <span id="debugCookies"></span></p>
        </div>
    </div>

    <!-- SCRIPTS (MANTIDOS ORIGINAIS COM PEQUENA OTIMIZAÇÃO) -->
    <script>
    const CONFIG = {
        whatsappNumber: "5512996450216",
        defaultMessage: "Olá, vi seu anúncio e quero saber mais!",
        debugMode: dataLayer.find(item => item.debug_mode) || false
    };

    function redirectToWhatsApp() {
        const encodedMsg = encodeURIComponent(CONFIG.defaultMessage);
        const isMobile = /Android|iPhone|iPad/i.test(navigator.userAgent);
        const whatsappUrl = isMobile ?
            `whatsapp://send?phone=${CONFIG.whatsappNumber}&text=${encodedMsg}` :
            `https://web.whatsapp.com/send?phone=${CONFIG.whatsappNumber}&text=${encodedMsg}`;

        // Disparo de evento para GTM antes do redirecionamento
        dataLayer.push({
            'event': 'whatsapp_redirect',
            'whatsapp_number': CONFIG.whatsappNumber,
            'is_mobile': isMobile
        });

        if (CONFIG.debugMode) {
            document.getElementById('debugPanel').style.display = 'block';
            document.getElementById('debugFbclid').textContent = localStorage.getItem('ultimo_fbclid') || 'Não encontrado';
            document.getElementById('debugUrl').textContent = whatsappUrl;
            document.getElementById('debugCookies').textContent = JSON.stringify({
                _fbc: document.cookie.match(/_fbc=([^;]+)/)?.[1],
                _fbp: document.cookie.match(/_fbp=([^;]+)/)?.[1]
            }, null, 2);
            document.getElementById('manualRedirect').href = whatsappUrl;
        } else {
            window.location.href = whatsappUrl;
            setTimeout(() => {
                document.body.innerHTML = `
                    <div class="container">
                        <h1>Ops, algo deu errado!</h1>
                        <p>Não conseguimos redirecionar automaticamente.</p>
                        <a href="${whatsappUrl}" class="btn">Abrir WhatsApp Agora</a>
                    </div>
                `;
            }, 3000);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('manualRedirect').addEventListener('click', function(e) {
            e.preventDefault();
            redirectToWhatsApp();
        });
        setTimeout(redirectToWhatsApp, 3000);
    });
    </script>
</body>
</html>
